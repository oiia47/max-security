<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Protected Site — Loading…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#0f1724; color:#e6eef8;}
    .box { text-align:center; padding:28px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); width:min(700px,92%); }
    progress { width:100%; height:14px; border-radius:8px; }
    .hidden { display:none; }
    .badge { background:#102a43; color:#9ad; padding:6px 10px; border-radius:999px; font-size:13px; }
  </style>
</head>
<body>
  <div class="box" id="box">
    <h1>Verifying your browser…</h1>
    <p class="badge" id="status">Preparing challenge</p>
    <p style="margin-top:14px">This helps protect the site from automated traffic. This should take <span id="est">few seconds</span>.</p>
    <progress id="progress" value="0" max="100"></progress>
    <div id="content" class="hidden" style="margin-top:18px;">
      <h2>Welcome — you passed the challenge ✅</h2>
      <p>The protected site content goes here.</p>
    </div>
  </div>

<script>
(async function(){
  const difficulty = 20; // number of leading zero bits required (adjust: 16-28 recommended)
  const status = document.getElementById('status');
  const progress = document.getElementById('progress');
  const est = document.getElementById('est');
  const content = document.getElementById('content');

  // quick ETA message
  est.textContent = (difficulty <= 20) ? 'a couple seconds' : 'several seconds';

  // helper: compute SHA-256 using Web Crypto, returns hex
  async function sha256Hex(msgUint8) {
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // helper: convert string to Uint8Array
  function str2ab(str) { return new TextEncoder().encode(str); }

  // checks first N bits are zero
  function hasLeadingZeroBits(hexStr, bits) {
    // examine full bytes then leftover bits
    const bytesNeeded = Math.floor(bits / 8);
    const leftoverBits = bits % 8;
    // convert hex to bytes on the fly
    for (let i = 0; i < bytesNeeded; i++) {
      const byte = parseInt(hexStr.substr(i*2, 2), 16);
      if (byte !== 0) return false;
    }
    if (leftoverBits === 0) return true;
    const nextByte = parseInt(hexStr.substr(bytesNeeded*2, 2), 16);
    // top leftoverBits of nextByte must be zero
    const mask = 0xFF << (8 - leftoverBits) & 0xFF;
    return (nextByte & mask) === 0;
  }

  // PoW: find a nonce so SHA256(prefix|nonce) has requirement
  const prefix = `${location.hostname}|${Math.floor(Date.now()/1000)}`; // include second-precision timestamp
  status.textContent = `Solving challenge (difficulty ${difficulty} bits)…`;
  let attempt = 0;
  const start = performance.now();
  for (let nonce = 0; nonce < 2**31; nonce++) {
    attempt++;
    if ((attempt & 255) === 0) {
      // update UI occasionally
      progress.value = Math.min(100, (attempt % 100000)/1000);
      status.textContent = `Solving... attempts ${attempt.toLocaleString()}`;
      await new Promise(r => setTimeout(r,0)); // yield to UI every so often
    }
    const message = `${prefix}|${nonce}`;
    const hash = await sha256Hex(str2ab(message));
    if (hasLeadingZeroBits(hash, difficulty)) {
      const duration = ((performance.now() - start)/1000).toFixed(2);
      status.textContent = `Solved in ${duration}s (${attempt.toLocaleString()} attempts)`;
      // OPTIONAL: send proof to server for validation or set local cookie
      document.cookie = `pow=${encodeURIComponent(btoa(JSON.stringify({prefix,nonce,hash})))}; max-age=60; path=/; samesite=lax`;
      progress.value = 100;
      content.classList.remove('hidden');
      return;
    }
  }
  status.textContent = 'Failed to solve challenge (try reload).';
})();
</script>
</body>
</html>
